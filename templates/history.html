<!DOCTYPE html>
<html>
<head>
    <title>Dialogue History</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
    <h1>Dialogue History</h1>
    <div id="dialogues-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadDialogues();
        });

        async function loadDialogues() {
            try {
                const response = await fetch('/api/dialogues');
                const dialogues = await response.json();
                
                const container = document.getElementById('dialogues-container');
                container.innerHTML = '';
                
                dialogues.forEach(dialogue => {
                    const dialogueDiv = createDialogueElement(dialogue);
                    container.appendChild(dialogueDiv);
                });
                
            } catch (error) {
                console.error('Error loading dialogues:', error);
                document.getElementById('dialogues-container').innerHTML = 
                    '<p>Error loading dialogues</p>';
            }
        }

        function createDialogueElement(dialogue) {
            const dialogueDiv = document.createElement('div');
            dialogueDiv.style.borderBottom = '1px solid black';
            dialogueDiv.style.margin = '10px 0';
            dialogueDiv.style.padding = '10px';
            
            // Create header with ID and buttons
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            
            // Left side - expandable content
            const leftDiv = document.createElement('div');
            leftDiv.style.cursor = 'pointer';
            leftDiv.style.fontWeight = 'bold';
            
            const expandSymbol = document.createElement('span');
            expandSymbol.textContent = '+';
            expandSymbol.style.marginRight = '10px';
            expandSymbol.style.fontSize = '18px';
            
            const idText = document.createElement('span');
            idText.textContent = `Dialogue ID: ${dialogue.id}`;
            
            const dateText = document.createElement('span');
            dateText.textContent = ` (${new Date(dialogue.created_at).toLocaleString()})`;
            dateText.style.fontWeight = 'normal';
            dateText.style.color = '#666';

            const firstPara =  document.createElement('span');
            firstPara.style.fontWeight = 'normal';
            firstPara.style.color = '#666';
            firstPara.textContent = `${'  ' + dialogue.blocks[0].text.substring(0, 50) + '...'}`;

            leftDiv.appendChild(expandSymbol);
            leftDiv.appendChild(idText);
            leftDiv.appendChild(dateText);
            leftDiv.appendChild(firstPara);
            
            // Right side - buttons
            const buttonsDiv = document.createElement('div');
            const audioButton = document.createElement('button');

            if(dialogue.audio) {
                audioButton.textContent = 'View Audio';
                audioButton.style.marginRight = '5px';
                audioButton.style.backgroundColor = 'green';
                audioButton.style.color = 'white';
                audioButton.addEventListener('click', function() {
                    window.location.replace('/dialogue/' + dialogue.id)
                });
            }

            else {
                audioButton.textContent = 'Generate Audio';
                audioButton.style.marginRight = '5px';
                audioButton.addEventListener('click', function() {
                    window.location.replace('/generate-audio?id=' + dialogue.id)
                });
            }

            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.style.marginRight = '5px';
            
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.style.backgroundColor = '#dc3545';
            deleteButton.style.color = 'white';
            deleteButton.style.border = 'none';
            deleteButton.style.padding = '4px 8px';
            
            buttonsDiv.appendChild(audioButton);
            buttonsDiv.appendChild(editButton);
            buttonsDiv.appendChild(deleteButton);
            
            header.appendChild(leftDiv);
            header.appendChild(buttonsDiv);
            
            // Create content div (initially hidden)
            const content = document.createElement('div');
            content.style.display = 'none';
            content.style.marginTop = '10px';
            content.id = `content-${dialogue.id}`;
            
            // Add prompt
            const promptDiv = document.createElement('div');
            promptDiv.innerHTML = `<strong>Prompt:</strong> ${dialogue.prompt}`;
            content.appendChild(promptDiv);
            
            // Add initial response
            const initialDiv = document.createElement('div');
            initialDiv.innerHTML = `<strong>Initial Response:</strong> ${dialogue.initial_response}`;
            initialDiv.style.marginTop = '10px';
            content.appendChild(initialDiv);
            
            // Add blocks
            if (dialogue.blocks && dialogue.blocks.length > 0) {
                const blocksDiv = document.createElement('div');
                blocksDiv.innerHTML = '<strong>Dialogue:</strong>';
                blocksDiv.style.marginTop = '10px';
                
                dialogue.blocks.forEach(block => {
                    const blockDiv = document.createElement('div');
                    blockDiv.innerHTML = `<strong>Speaker ${block.speaker}:</strong> ${block.text}`;
                    blockDiv.style.marginLeft = '20px';
                    blockDiv.style.marginTop = '5px';
                    blocksDiv.appendChild(blockDiv);
                });
                
                content.appendChild(blocksDiv);
            }
            
            // Event listeners
            leftDiv.addEventListener('click', function() {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    expandSymbol.textContent = '-';
                } else {
                    content.style.display = 'none';
                    expandSymbol.textContent = '+';
                }
            });

            editButton.addEventListener('click', function() {
                editDialogue(dialogue);
            });
            
            deleteButton.addEventListener('click', function() {
                deleteDialogue(dialogue.id);
            });
            
            dialogueDiv.appendChild(header);
            dialogueDiv.appendChild(content);
            
            return dialogueDiv;
        }

        async function deleteDialogue(id) {
            if (!confirm('Are you sure you want to delete this dialogue?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/dialogues/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadDialogues();
                } else {
                    alert('Failed to delete dialogue');
                }
            } catch (error) {
                console.error('Error deleting dialogue:', error);
                alert('Error deleting dialogue');
            }
        }

        function editDialogue(dialogue) {
            const content = document.getElementById(`content-${dialogue.id}`);
            content.innerHTML = '';
            
            const form = document.createElement('form');
            
            // Prompt
            const promptLabel = document.createElement('p');
            promptLabel.innerHTML = '<b>Prompt: </b>' + dialogue.prompt;
            form.appendChild(promptLabel);
            // Initial response
            const initialLabel = document.createElement('p');
            initialLabel.innerHTML = '<b>Initial Response: </b>' + dialogue.initial_response;
            form.appendChild(initialLabel);
            
            // Blocks
            const blocksLabel = document.createElement('label');
            blocksLabel.innerHTML = '<h3>Dialogue Blocks:</h3>';
            form.appendChild(blocksLabel);
            
            dialogue.blocks.forEach((block, i) => {
                const blockLabel = document.createElement('label');
                blockLabel.innerHTML = `<b>Speaker ${block.speaker}</b>:`;
                const blockInput = document.createElement('textarea');
                blockInput.value = block.text;
                blockInput.name = `block_${i}`;
                blockInput.dataset.speaker = block.speaker;
                
                form.appendChild(blockLabel);
                form.appendChild(document.createElement('br'));
                form.appendChild(blockInput);
                form.appendChild(document.createElement('br'));
            });
            
            // Buttons
            const saveButton = document.createElement('button');
            saveButton.type = 'submit';
            saveButton.textContent = 'Save';
            
            const cancelButton = document.createElement('button');
            cancelButton.type = 'button';
            cancelButton.textContent = 'Cancel';
            
            form.appendChild(saveButton);
            form.appendChild(cancelButton);
            
            // Event listeners
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                saveDialogue(dialogue.id, form);
            });
            
            cancelButton.addEventListener('click', function() {
                loadDialogues();
            });
            
            content.appendChild(form);
            content.style.display = 'block';
        }

        async function saveDialogue(id, form) {
            const blocks = [];
            const blockInputs = form.querySelectorAll('textarea[name^="block_"]');
            blockInputs.forEach(input => {
                blocks.push({
                    speaker: input.dataset.speaker,
                    text: input.value.trim()
                });
            });
            
            // Get original dialogue data for prompt and initial_response
            const response = await fetch('/api/dialogues');
            const dialogues = await response.json();
            const originalDialogue = dialogues.find(d => d.id === id);
            
            const data = {
                prompt: originalDialogue.prompt,
                initial_response: originalDialogue.initial_response,
                blocks: blocks
            };
            
            try {
                const response = await fetch(`/api/dialogues/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    loadDialogues();
                } else {
                    alert('Failed to update dialogue');
                }
            } catch (error) {
                console.error('Error updating dialogue:', error);
                alert('Error updating dialogue');
            }
        }
    </script>
</body>
</html>