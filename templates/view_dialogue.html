<!DOCTYPE html>
<html>
<head>
  <title>Dialogue {{ dialogue_id }}</title>
  <link rel="stylesheet" href="/static/audio-gen.css" />
</head>
<body>
  <h1>Dialogue {{ dialogue_id }}</h1>
  <p>back to <a href="{{ url_for('generate_audio') }}">generate audio</a> ~ back to <a href="/history">history</a></p>
  {% for block in blocks %}
  <div class="block">
    <form class="audio-form" style="margin-bottom:20px;">
      <input type="hidden" name="block_order" value="{{ block.block_order }}">
      <input type="hidden" name="block_id" value="{{ block.id }}">
      <input type="hidden" name="speaker" value="{{ block.speaker }}">

      <h3>Speaker {{ block.speaker }} (Block {{ block.block_order }})</h3>

      <textarea name="text" rows="3" cols="60">{{ block.text }}</textarea><br><br>

      <div class="audio-container">
        {% if block.file_path %}
          <audio id="audio-{{ block.block_order }}" controls>
            <source src="{{ url_for('serve_audio', filename=block.file_path) }}?t={{ timestamp }}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
           <span id="status-{{ block.block_order }}" class="status-dot"></span>
        {% else %}
          <p><em>No audio yet for this block</em></p>
        {% endif %}
      </div>

      <label for="voice">Voice:</label>
      <select name="voice" required>
        {% if block.voice == "sherron" %}
          <option value="sherron" selected>
            Sherron Watkins
          </option>
          <option value="james">
            James Timmins
          </option>
        {% else %}
          <option value="sherron">
            Sherron Watkins
          </option>
          <option value="james" selected>
            James Timmins
          </option>
        {% endif %}
      </select><br>

    <div id="params">
    <div>
    <!-- Stability -->
    <label for="stability">Stability: 
      <span id="stability-value-{{ block.block_order }}">{{ block.stability or 0.0 }}</span>
    </label>
    <input type="range" step="0.1" min="0.0" max="1.0" name="stability" value="{{ block.stability or 0.0 }}"
           oninput="document.getElementById('stability-value-{{ block.block_order }}').innerText = this.value"><br>
    </div>

    <!-- Style -->
    <div>
    <label for="style">Style: 
      <span id="style-value-{{ block.block_order }}">{{ block.style or 0.0 }}</span>
    </label>
    <input type="range" step="0.1" min="0.0" max="1.0" name="style" value="{{ block.style or 0.0 }}"
           oninput="document.getElementById('style-value-{{ block.block_order }}').innerText = this.value"><br>
    </div>


    <!-- Similarity -->
    <div>
    <label for="similarity_boost">Similarity Boost: 
      <span id="similarity-value-{{ block.block_order }}">{{ block.similarity_boost or 0.0 }}</span>
    </label>
    <input type="range" step="0.1" min="0.0" max="1.0" name="similarity_boost" value="{{ block.similarity_boost or 0.0 }}"
           oninput="document.getElementById('similarity-value-{{ block.block_order }}').innerText = this.value"><br>
    </div>

    <!-- Speed -->
    <div>
    <label for="speed">Speed: 
      <span id="speed-value-{{ block.block_order }}">{{ block.speed or 1.0 }}</span>
    </label>
    <input type="range" step="0.01" min="0.7" max="1.2" name="speed" value="{{ block.speed or 1.0 }}"
           oninput="document.getElementById('speed-value-{{ block.block_order }}').innerText = this.value"><br>
      </div>
    </div>

    <!-- Speaker boost -->
    <label>
      <input type="checkbox" name="use_speaker_boost" {% if block.use_speaker_boost %}checked{% endif %}>
      Use Speaker Boost
    </label>

      {% if block.file_path %}
        <button type="submit">regenerate</button>
      {% else %}
        <button type="submit">generate</button>
      {% endif %}

    </form>
  </div>
  {% endfor %}
</body>

<script>
document.querySelectorAll(".audio-form").forEach(form => {
  form.addEventListener("submit", async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    // const blockId = formData.get("block_id");
    const blockOrder = formData.get("block_order");

    const statusDot = document.getElementById(`status-${blockOrder}`);
    statusDot.classList.remove("ready");
    statusDot.classList.add("generating");

    const response = await fetch(this.action, {
      method: "POST",
      body: formData
    });

    if (response.ok) {
      // Reload only the audio element
      const audioEl = document.getElementById(`audio-${blockOrder}`);
      const sourceEl = audioEl.querySelector("source");
      // Add cache-busting timestamp
      sourceEl.src = sourceEl.src.split("?")[0] + "?t=" + Date.now();
      audioEl.load();
      statusDot.classList.remove("generating");
      statusDot.classList.add("ready");
    } else {
      statusDot.classList.remove("generating");
      statusDot.style.backgroundColor = "red"; // error case
      alert("Error generating audio!");
    }
  });
});
</script>
</html>
